{% extends 'trans_navbar.html' %}
{% load django_bootstrap5 %}
{% load static %}

{% block css %}
  <link rel="stylesheet" href="{% static 'communities/css/style.css' %}">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
{% endblock css %}

{% block body %}

  <!-- í”¼ë“œ ë©”ì¸ -->
  <div class="community-header"></div>

  <!-- í”¼ë“œ ê³µì§€ì‚¬í•­ -->
  <div style="max-width: 733px; background-color: white; margin: 0 auto;">
    <section style="padding: 0 18px">
      <h2 style="font-size: 19px; max-width: 732px; margin: 0 auto; font-weight: 700; padding-top: 45px;">
        <span style='margin-right: 14px'>âœˆï¸</span>ê³µì§€ì‚¬í•­
      </h2>
      <div style="margin: 8px auto 0;  background-color: white; border-radius: 16px; max-width: 732px; max-height: 184px; padding: 12px 0 0;">
        <ul style="padding-top: 30px; padding: 0px;">
          <div class="reviews-row" style="padding: 0">
          </div>
        </ul>
      </div>
    </section>

    <!-- í”¼ë“œ ë¦¬ë·° -->
    
    <section style="margin-top: 45px; padding: 0 18px">
      <div class="d-flex justify-content-between align-items-center">
        <h2 style="font-size: 19px; max-width: 732px; font-weight: 700;">
          <span style='margin-right: 14px'>ğŸ–¥ï¸</span>ë¦¬ë·°ëª©ë¡
        </h2>
        <!-- <div class="create-wrapper"> <a href="{% url 'communities:review_create' country_code %}" style="text-decoration: none;"> <div class="create"> ë¦¬ë·°ì‘ì„± <img class="plane" src="{% static 'communities/img/create.png' %}" alt=""> </div> </a> </div> -->
        <!-- <button id="create-feed" class="btn btn-outline-success" onclick="getCreateFeed(this.id)">í”¼ë“œìƒì„±
        </button> -->
        
      </div>
      <div id="create-feed-form">
          <form id="feed-create" data-country-id="{{ country_code }}" onsubmit="createFeed(this.id)">
            {% csrf_token %}
            {% bootstrap_form feed_form %}
            {% bootstrap_button "í”¼ë“œ ìƒì„±" %}
          </form>
        </div>
      <div id="feed-list" style="margin: 8px auto 0; padding: 13px 0; background-color: white; border-radius: 16px; max-width: 732px; overflow-y: scroll">
        <ul style="padding-top: 15px; padding: 0px;">
          {% for feed in feeds %}
          <div class="feed-row" id="feed-{{ feed.pk }}-row">
            <div class="feed-wrapper">
              <div class="feed-user">
                <div class="feed-img-div">
                  <img src="{{ feed.user.profile_image.url }}" alt="" class="feed-profile-img">
                </div>
              </div>
                <div class="feed-main">
                  <div class="feed-user-date">
                    <p style="font-weight: 400;">{{ feed.user.nick_name }}</p>
                    <p class="feed-date">
                      <!-- ì‘ì„±ì¼ì : ~ì‹œê°„ ì „ í‘œì‹œ -->
                      {% if feed.created_string == False %}
                      <!-- 7ì¼ì´ ì§€ë‚˜ë©´ ë‚ ì§œë¡œ ì¶œë ¥ -->
                      {{ feed.created_at | date:'mì›” dì¼' }}
                      {% else %}
                      <!-- 7ì¼ì´ ì§€ë‚˜ê¸° ì „ì´ë¼ë©´ í•¨ìˆ˜ ëŒ€ì…í•œ ê²°ê³¼ -->
                      {{ feed.created_string }}
                      {% endif %}
                    </p>
                  </div>
                    <p id="feed-{{ feed.pk }}-update-hide">{{ feed.content }}</p>
                    <div id="feed-{{ feed.pk }}-update-form" class="update-form">
                      <textarea id="feed-{{ feed.pk }}-update-content"
                        type="text">{{ feed.content }}</textarea>
                      <div class="buttons-update">
                        <button id="feed-{{ feed.pk }}-update-cancel"
                          data-feed-id="{{ feed.pk }}"
                          onclick="updateFeedCancel(this.id)">ì·¨ì†Œ</button>
                        <button id="feed-{{ feed.pk }}-update-btn" class="update-feed"
                          data-feed-id="{{ feed.pk }}"
                          onclick="updateFeed(this.id)">ì‘ì„±
                        </button>
                      </div>
                    </div>
                </div>
                <button id="feed-{{ feed.pk }}" class="feed-comment-btn"
                  onclick="getCreateFeed(this.id)">ë‹µê¸€ë‹¬ê¸°</button>
                {% if user.pk == feed.user_id %}
                <div id="feed-{{feed.pk}}-update-buttons" class="buttons">
                  <button id="feed-{{ feed.pk }}-update"
                    data-feed-id="{{ feed.pk }}" onclick="getUpdateFeed(this.id)">ìˆ˜ì •
                  </button>
                  <button id="feed-{{ feed.pk }}-delete"
                    data-feed-id="{{ feed.pk }}" onclick="deleteFeed(this.id)">ì‚­ì œ
                  </button>
                </div>
                {% endif %}
            </div>
          </div>
          {% endfor %}
        </ul>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    //êµ­ê°€ ì½”ë“œ ì„ ì–¸
    //êµ­ê°€ ì½”ë“œ ì„ ì–¸
    let conPK = '{{ country_code }}';
    console.log(conPK)

    function displayedAt(createdAt) {
      let time = new Date(createdAt)
      const milliSeconds = new Date() - time
      const seconds = milliSeconds / 1000
      if (seconds < 60) 
        return `ë°©ê¸ˆ ì „`
      const minutes = seconds / 60
      if (minutes < 60) 
        return `${Math.floor(minutes)}ë¶„ ì „`
      const hours = minutes / 60
      if (hours < 24) 
        return `${Math.floor(hours)}ì‹œê°„ ì „`
      const days = hours / 24
      if (days < 7) 
        return `${Math.floor(days)}ì¼ ì „`
      const weeks = days / 7
      if (weeks < 5) 
        return `${Math.floor(weeks)}ì£¼ ì „`
      const months = days / 30
      if (months < 12) 
        return `${Math.floor(months)}ê°œì›” ì „`
      const years = days / 365
      return `${Math.floor(years)}ë…„ ì „`
    }

    //csrfí† í° ì¶”ê°€
    //csrfí† í° ì¶”ê°€
    const csrftoken = document
      .querySelector('[name=csrfmiddlewaretoken]')
      .value;

    // í”¼ë“œ ìƒì„± ì°½ ë„ìš°ê¸°
    // í”¼ë“œ ìƒì„± ì°½ ë„ìš°ê¸°
    const getCreateFeed = function (e) {
      const createFeedForm = document.querySelector(`#${e}-form`);
      createFeedForm
        .classList
        .toggle(`d-none`);
    }

    // í”¼ë“œ ìƒì„±
    // í”¼ë“œ ìƒì„±
    const createFeed = function (e) {
      event.preventDefault();
      const feedForm = document.querySelector(`#${e}`);
      const pk = event.target.dataset.articleId;
      axios({
        method: 'post',
        url: `/communities/${conPK}/feed/feed_create`,
        headers: {
          'X-CSRFToken': csrftoken
        },
        data: new FormData(feedForm)
      }).then(response => {
        console.log(response)

        const feedList = document.querySelector(`#feed-list`)

        feedList.textContent = "";

        for (let i = 0; i < response.data.feeds_data.length; i++) {
          let date = displayedAt(response.data.feeds_data[i].created_at)
          if (response.data.feeds_data[i].request_user_pk === response.data.feeds_data[i].user_pk) {
            feedList.insertAdjacentHTML('beforeend', `
            <div class="feed-row" id="feed-${response.data.feeds_data[i].feed_pk}-row">
              <div class="feed-wrapper">
                <div class="feed-user">
                  <div class="feed-img-div">
                    <img src="${response.data.feeds_data[i].img_url}" alt="" class="feed-profile-img">
                  </div>
                </div>
                  <div class="feed-main">
                    <div class="feed-user-date">
                      <p style="font-weight: 400;">${response.data.feeds_data[i].nick_name}</p>
                      <p class="feed-date">
                        ${date}
                      </p>
                    </div>
                      <p id="feed-${response.data.feeds_data[i].feed_pk}-update-hide">${response.data.feeds_data[i].content}</p>
                      <div id="feed-${response.data.feeds_data[i].feed_pk}-update-form" class="update-form">
                        <textarea id="feed-${response.data.feeds_data[i].feed_pk}-update-content"
                          type="text">${response.data.feeds_data[i].content}</textarea>
                        <div class="buttons-update">
                          <button id="feed-${response.data.feeds_data[i].feed_pk}-update-cancel"
                            data-feed-id="${response.data.feeds_data[i].feed_pk}"
                            onclick="updateFeedCancel(this.id)">ì·¨ì†Œ</button>
                          <button id="feed-${response.data.feeds_data[i].feed_pk}-update-btn" class="update-feed"
                            data-feed-id="${response.data.feeds_data[i].feed_pk}"
                            onclick="updateFeed(this.id)">ì‘ì„±
                          </button>
                        </div>
                      </div>
                  </div>
                  <button id="feed-${response.data.feeds_data[i].feed_pk}" class="feed-comment-btn"
                    onclick="getCreateFeed(this.id)">ë‹µê¸€ë‹¬ê¸°</button>
                  <div id="feed-${response.data.feeds_data[i].feed_pk}-update-buttons" class="buttons">
                    <button id="feed-${response.data.feeds_data[i].feed_pk}-update"
                      data-feed-id="${response.data.feeds_data[i].feed_pk}" onclick="getUpdateFeed(this.id)">ìˆ˜ì •
                    </button>
                    <button id="feed-${response.data.feeds_data[i].feed_pk}-delete"
                      data-feed-id="${response.data.feeds_data[i].feed_pk}" onclick="deleteFeed(this.id)">ì‚­ì œ
                    </button>
                  </div>
              </div>
            </div>`);
          } else {
            feedList.insertAdjacentHTML('beforeend', `
            <div class="feed-row" id="feed-${response.data.feeds_data[i].feed_pk}-row">
              <div class="feed-wrapper">
                <div class="feed-user">
                  <div class="feed-img-div">
                    <img src="${response.data.feeds_data[i].img_url}" alt="" class="feed-profile-img">
                  </div>
                </div>
                  <div class="feed-main">
                    <div class="feed-user-date">
                      <p style="font-weight: 400;">${response.data.feeds_data[i].nick_name}</p>
                      <p class="feed-date">
                        ${date}
                      </p>
                    </div>
                      <p id="feed-${response.data.feeds_data[i].feed_pk}-update-hide">${response.data.feeds_data[i].content}</p>
                  </div>
                  <button id="feed-${response.data.feeds_data[i].feed_pk}" class="feed-comment-btn"
                    onclick="getCreateFeed(this.id)">ë‹µê¸€ë‹¬ê¸°</button>
                  <div id="feed-${response.data.feeds_data[i].feed_pk}-update-buttons" class="buttons">
                    <button id="feed-${response.data.feeds_data[i].feed_pk}-update"
                      data-feed-id="${response.data.feeds_data[i].feed_pk}" onclick="getUpdateFeed(this.id)">ìˆ˜ì •
                    </button>
                    <button id="feed-${response.data.feeds_data[i].feed_pk}-delete"
                      data-feed-id="${response.data.feeds_data[i].feed_pk}" onclick="deleteFeed(this.id)">ì‚­ì œ
                    </button>
                  </div>
              </div>
            </div>`);
          }
        }
      })
    }

    // í”¼ë“œ ì‚­ì œ
    // í”¼ë“œ ì‚­ì œ
    const deleteFeed = function (e) {
      const pk = event.target.dataset.feedId;
      if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?!") === true) {
        axios({
          method: 'post',
          url: `/communities/${conPK}/feed/${pk}/feed_delete/`,
          headers: {
              'X-CSRFToken': csrftoken
          }
        }).then(response => {

          console.log(response)

          const feedList = document.querySelector(`#feed-list`)

          feedList.textContent = "";

          for (let i = 0; i < response.data.feeds_data.length; i++) {
            let date = displayedAt(response.data.feeds_data[i].created_at)
            if (response.data.feeds_data[i].request_user_pk === response.data.feeds_data[i].user_pk) {
            feedList.insertAdjacentHTML('beforeend', `
            <div class="feed-row" id="feed-${response.data.feeds_data[i].feed_pk}-row">
              <div class="feed-wrapper">
                <div class="feed-user">
                  <div class="feed-img-div">
                    <img src="${response.data.feeds_data[i].img_url}" alt="" class="feed-profile-img">
                  </div>
                </div>
                  <div class="feed-main">
                    <div class="feed-user-date">
                      <p style="font-weight: 400;">${response.data.feeds_data[i].nick_name}</p>
                      <p class="feed-date">
                        ${date}
                      </p>
                    </div>
                      <p id="feed-${response.data.feeds_data[i].feed_pk}-update-hide">${response.data.feeds_data[i].content}</p>
                      <div id="feed-${response.data.feeds_data[i].feed_pk}-update-form" class="update-form">
                        <textarea id="feed-${response.data.feeds_data[i].feed_pk}-update-content"
                          type="text">${response.data.feeds_data[i].content}</textarea>
                        <div class="buttons-update">
                          <button id="feed-${response.data.feeds_data[i].feed_pk}-update-cancel"
                            data-feed-id="${response.data.feeds_data[i].feed_pk}"
                            onclick="updateFeedCancel(this.id)">ì·¨ì†Œ</button>
                          <button id="feed-${response.data.feeds_data[i].feed_pk}-update-btn" class="update-feed"
                            data-feed-id="${response.data.feeds_data[i].feed_pk}"
                            onclick="updateFeed(this.id)">ì‘ì„±
                          </button>
                        </div>
                      </div>
                  </div>
                  <button id="feed-${response.data.feeds_data[i].feed_pk}" class="feed-comment-btn"
                    onclick="getCreateFeed(this.id)">ë‹µê¸€ë‹¬ê¸°</button>
                  <div id="feed-${response.data.feeds_data[i].feed_pk}-update-buttons" class="buttons">
                    <button id="feed-${response.data.feeds_data[i].feed_pk}-update"
                      data-feed-id="${response.data.feeds_data[i].feed_pk}" onclick="getUpdateFeed(this.id)">ìˆ˜ì •
                    </button>
                    <button id="feed-${response.data.feeds_data[i].feed_pk}-delete"
                      data-feed-id="${response.data.feeds_data[i].feed_pk}" onclick="deleteFeed(this.id)">ì‚­ì œ
                    </button>
                  </div>
              </div>
            </div>`);
          } else {
            feedList.insertAdjacentHTML('beforeend', `
            <div class="feed-row" id="feed-${response.data.feeds_data[i].feed_pk}-row">
              <div class="feed-wrapper">
                <div class="feed-user">
                  <div class="feed-img-div">
                    <img src="${response.data.feeds_data[i].img_url}" alt="" class="feed-profile-img">
                  </div>
                </div>
                  <div class="feed-main">
                    <div class="feed-user-date">
                      <p style="font-weight: 400;">${response.data.feeds_data[i].nick_name}</p>
                      <p class="feed-date">
                        ${date}
                      </p>
                    </div>
                      <p id="feed-${response.data.feeds_data[i].feed_pk}-update-hide">${response.data.feeds_data[i].content}</p>
                  </div>
                  <button id="feed-${response.data.feeds_data[i].feed_pk}" class="feed-comment-btn"
                    onclick="getCreateFeed(this.id)">ë‹µê¸€ë‹¬ê¸°</button>
                  <div id="feed-${response.data.feeds_data[i].feed_pk}-update-buttons" class="buttons">
                    <button id="feed-${response.data.feeds_data[i].feed_pk}-update"
                      data-feed-id="${response.data.feeds_data[i].feed_pk}" onclick="getUpdateFeed(this.id)">ìˆ˜ì •
                    </button>
                    <button id="feed-${response.data.feeds_data[i].feed_pk}-delete"
                      data-feed-id="${response.data.feeds_data[i].feed_pk}" onclick="deleteFeed(this.id)">ì‚­ì œ
                    </button>
                  </div>
              </div>
            </div>`);
          }
          }
        }
        )
      }
    }

    const getUpdateFeed = function (e) {
        console.log(e)
        const btNs = document.querySelector(`#${e}-buttons`)
        const updateFeedForm = document.querySelector(`#${e}-form`);
        const feedContent = document.querySelector(`#${e}-hide`);
        const feedBase = document.querySelector(`#${e}-hide`).innerText;

        btNs.style.display = "none";
        feedContent.style.display = "none";
        updateFeedForm.style.display = "block";
    }

  </script>

{% endblock %}

<!-- í”¼ë“œ ì²˜ìŒì— ì“´ê±° for ë¬¸ ì•ˆì— ë„£ìœ¼ë©´ ëŒì•„ê° -->
<div class="review-row">
  <div class="row">
    <div class="col-8" style="padding:0">
      <a style="text-decoration: none; color: rgb(51, 51, 51)">
        <p id="feed-{{ feed.pk }}-update-hide">{{ feed.content }}</p>
          <div id="feed-{{ feed.pk }}-update-form" class="update-form">
            <textarea id="feed-{{ feed.pk }}-update-content"
              type="text">{{ feed.content }}</textarea>
            <div class="buttons-update">
              <button id="feed-{{ feed.pk }}-update-cancel"
                data-feed-id="{{ feed.pk }}"
                onclick="updatefeedCancel(this.id)">ì·¨ì†Œ</button>
              <button id="feed-{{ feed.pk }}-update-btn" class="update-feed"
                data-article-id="{{ article.pk }}" data-feed-id="{{ feed.pk }}"
                onclick="updatefeed(this.id)">ì‘ì„±
              </button>
            </div>
          </div>
      </a>
      <!-- ë‹‰ë„¤ì„|ì‘ì„±ì¼ -->
      <!-- ë‹‰ë„¤ì„|ì‘ì„±ì¼ -->
      <!-- ë‹‰ë„¤ì„|ì‘ì„±ì¼ -->
      <p class="review-date">{{ feed.user }}|{{ feed.created_at }}</p>
      {% if user.pk == feed.user_id %}
        <div id="feed-{{ feed.pk }}-update-buttons" class="buttons">
            <button id="feed-{{ feed.pk }}-update" data-feed-id="{{ feed.pk }}"
                onclick="getUpdateFeed(this.id)">ìˆ˜ì •
            </button>
            <button id="feed-{{ feed.pk }}-delete" data-feed-id="{{ feed.pk }}"
                onclick="deleteFeed(this.id)">ì‚­ì œ
            </button>
        </div>
      {% endif %}
      <div class="icons-wrapper">
        <div class="icons">
          <!-- ì¢‹ì•„ìš” -->
          <!-- ì¢‹ì•„ìš” -->
          <!-- ì¢‹ì•„ìš” -->
          <div class="icon">
            <span class="material-icons md-18">
              thumb_up_alt
            </span>
            <span>{{ feed.like.count }}</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-4 review-list">
      {% if feed.image %}
        <div>
          <img class="review-img" src="{{ feed.image.url }}" alt="">
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ëŒ“ê¸€ ë¶€ë¶„ ì¶”ê°€í•˜ë©´ ë˜ sub ë¹¼ê³  -->
<div id="subcomment-{{ comment.pk }}-commentlist" data-comment-id="{{ comment.pk }}"
  class="sub-comment-list">
  <!-- ì´ ëŒ“ê¸€ì„ ì°¸ì¡°í•˜ê³  ìˆëŠ” ëª¨ë“  ëŒ€ëŒ“ê¸€ì„ ìˆœíšŒ -->
  {% for sub_comment in comment.articlecomment_set.all %}
  <span>{{ sub_comment.pk }}</span>
  <div class="comment-row" id="comment-{{ sub_comment.pk }}-row">
    <div class="comment-wrapper">
      <div class="comment-user">
        <div class="comment-img-div">
          <img src="{{ sub_comment.user.profile_image.url }}" alt=""
            class="comment-profile-img">
        </div>
      </div>
        <div class="comment-main">
          <div class="comment-user-date">
            <p style="font-weight: 400;">{{ sub_comment.user.nick_name }}</p>
            <p class="comment-date">
              <!-- ì‘ì„±ì¼ì : ~ì‹œê°„ ì „ í‘œì‹œ -->
              {% if comment.created_string == False %}
              <!-- 7ì¼ì´ ì§€ë‚˜ë©´ ë‚ ì§œë¡œ ì¶œë ¥ -->
              {{ comment.created_at | date:'mì›” dì¼' }}
              {% else %}
              <!-- 7ì¼ì´ ì§€ë‚˜ê¸° ì „ì´ë¼ë©´ í•¨ìˆ˜ ëŒ€ì…í•œ ê²°ê³¼ -->
              {{ comment.created_string }}
              {% endif %}
            </p>
          </div>
            <p id="comment-{{ sub_comment.pk }}-update-hide">{{ sub_comment.content }}</p>
            <div id="comment-{{ sub_comment.pk }}-update-form" class="update-form">
              <textarea id="comment-{{ sub_comment.pk }}-update-content"
                type="text">{{ sub_comment.content }}</textarea>
              <div class="buttons-update">
                <button id="comment-{{ sub_comment.pk }}-update-cancel"
                  data-comment-id="{{ sub_comment.pk }}"
                  onclick="updateCommentCancel(this.id)">ì·¨ì†Œ</button>
                <button id="comment-{{ sub_comment.pk }}-update-btn" class="update-comment"
                  data-article-id="{{ article.pk }}"
                  data-comment-id="{{ sub_comment.pk }}"
                  onclick="updateComment(this.id)">ì‘ì„±
                </button>
              </div>
            </div>
        </div>
        {% if user.pk == sub_comment.user_id %}
        <div id="comment-{{ sub_comment.pk}}-update-buttons" class="buttons">
          <button id="comment-{{ sub_comment.pk }}-update" data-article-id="{{ article.pk }}"
            data-comment-id="{{ sub_comment.pk }}" onclick="getUpdateComment(this.id)">ìˆ˜ì •
          </button>
          <button id="comment-{{ sub_comment.pk }}-delete" data-article-id="{{ article.pk }}"
            data-comment-id="{{ sub_comment.pk }}" onclick="deleteComment(this.id)">ì‚­ì œ
          </button>
        </div>
        {% endif %}
    </div>
  </div>
  {% endfor %}
  <div id="comment-{{ comment.pk }}-create-sub-comment" class="sub-comment-create">
    <form id="comment-{{ comment.pk }}-create-sub-comment-form"
      data-article-id="{{ article.pk }}" data-parent-id="{{ comment.pk }}"
      data-country-id="{{ country_code }}" onsubmit="submitSubComment(this.id)">
      <div class="mb-3"><label class="form-label" for="id_content">Content</label><input
        type="text" name="content" maxlength="150" class="form-control"
        placeholder="Content" required="" id="id_content"></div>
      <input type="submit" value="ì œì¶œ">
    </form>
  </div>
</div>